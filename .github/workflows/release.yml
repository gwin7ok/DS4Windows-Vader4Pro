name: Release (tag-triggered)

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Get version from tag
        id: get_version
        shell: pwsh
        run: |
          $refName = '${{ github.ref_name }}'
          if ($refName -match '^v(.+)$') {
            $v = $Matches[1]
            echo "version=$v" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding ascii -Append
          } else {
            Write-Error "Ref name is not a v* tag: $refName"
            exit 1
          }

      - name: Extract changelog section
        id: extract_changelog
        shell: pwsh
        run: |
          $v = '${{ steps.get_version.outputs.version }}'
          $out = 'changes.txt'
          if (Test-Path $out) { Remove-Item $out }
          $inSection = $false
          Get-Content CHANGELOG.md | ForEach-Object {
            if ($_ -match "^## \[$v\]") { $inSection = $true; return }
            if ($inSection -and ($_ -match '^## \[')) { $inSection = $false }
            if ($inSection) { Add-Content -Path $out -Value $_ }
          }
          if (-not (Test-Path $out) -or (Get-Content $out).Count -eq 0) { Write-Error "No changelog section found for version $v"; exit 1 }

      - name: Publish x64
        shell: pwsh
        run: |
          dotnet publish ./DS4Windows/DS4WinWPF.csproj -c Release /p:Platform=x64 -o ./artifacts/win-x64

      - name: Publish x86
        shell: pwsh
        run: |
          dotnet publish ./DS4Windows/DS4WinWPF.csproj -c Release /p:Platform=x86 -o ./artifacts/win-x86

      - name: Package artifacts (post-build)
        shell: pwsh
        run: |
          $v = '${{ steps.get_version.outputs.version }}'
          # Run the repository post-build script to normalize layout and create zips
          if (Test-Path './artifacts/win-x64') {
            Write-Host "Running post-build for artifacts/win-x64 ..."
            python ./utils/post-build.py ./artifacts/win-x64 . $v x64
          } else { Write-Warning './artifacts/win-x64 not found; skipping post-build x64' }

          if (Test-Path './artifacts/win-x86') {
            Write-Host "Running post-build for artifacts/win-x86 ..."
            python ./utils/post-build.py ./artifacts/win-x86 . $v x86
          } else { Write-Warning './artifacts/win-x86 not found; skipping post-build x86' }

          # After post-build.py runs it will create ./artifacts/DS4Windows_${v}_<arch>.zip
          if (-not (Test-Path "./artifacts/DS4Windows_${v}_x64.zip") -and -not (Test-Path "./artifacts/DS4Windows_${v}_x86.zip")) {
            Write-Error 'Expected zip artifacts not found after post-build'
            exit 1
          }
      - name: Delete existing GitHub Release if present
        id: delete_old_release
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          $v = '${{ steps.get_version.outputs.version }}'
          $tag = "v$v"
          $repo = $env:REPO
          $uri = "https://api.github.com/repos/$repo/releases/tags/$tag"
          $headers = @{ Authorization = "token $env:GITHUB_TOKEN"; "User-Agent" = "actions" }
          try {
            $resp = Invoke-RestMethod -Uri $uri -Headers $headers -Method Get -ErrorAction Stop
            if ($null -ne $resp -and $resp.id) {
              Write-Output "Found existing release id $($resp.id) for $tag. Deleting..."
              $delUri = "https://api.github.com/repos/$repo/releases/$($resp.id)"
              Invoke-RestMethod -Uri $delUri -Headers $headers -Method Delete -ErrorAction Stop
              Write-Output "Deleted release $tag (id $($resp.id))."
            }
          } catch {
            # If release doesn't exist, GET returns 404 which will be caught here - that's fine
            Write-Output "No existing release for $tag or could not query releases: $($_.Exception.Message)"
          }

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.get_version.outputs.version }}
          name: Release v${{ steps.get_version.outputs.version }}
          body_path: changes.txt
          files: |
            artifacts/DS4Windows_${{ steps.get_version.outputs.version }}_x64.zip
            artifacts/DS4Windows_${{ steps.get_version.outputs.version }}_x86.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}