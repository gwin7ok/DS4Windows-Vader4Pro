# Special Action Save — Test Plan

目的: スペシャルアクション編集と保存に関する振る舞い（重複検出、プロファイル参照置換、UI での置換の安全性）を検証するための手順と期待結果をまとめる。

## 環境
- ビルド済みのアプリ (Debug/Release) を起動して UI で操作する
- 変更したコードは `3.11.4` ブランチに適用済

## テストケース一覧

1) 名前重複検出（同名）
- 前提: Actions.xml に `Disconnect Controller` というアクションが存在する
- 操作: 既存アクションを編集して名前を `Disconnect Controller` に変更して Save
- 期待: ダイアログで `そのスペシャルアクション名はすでに存在しています` が表示され、編集画面は閉じない。Actions.xml は変更されない。

2) 名前変更とプロファイル参照の置換（同プロファイル）
- 前提: 現在編集中プロファイルの `ProfileActions` に `OldActionName` が含まれている
- 操作: `OldActionName` を編集して `NewActionName` に変更し Save
- 期待: 保存後、該当プロファイルの `ProfileActions` 内の `OldActionName` が `NewActionName` に置換される。UI リスト上でも古い項目は消え、新しい項目が同じ場所（または新しいソート順）に表示される。

3) UI 重複再現確認
- 前提: 既知の再現手順（過去に duplicate が出たシナリオ）を用意
- 操作: その手順に従って編集→保存を行う
- 期待: 2つ並列で同一アクションが表示される事象が発生しない

4) 無変更保存（名前未変更）
- 操作: アクションを開き、名前は変更せずに Save
- 期待: 正常に保存され、一覧は変わらない（重複チェックはスキップされる）

5) 空白や前後空白のみの変化
- 操作: 名前が `Foo` のアクションを ` Foo ` に変更して Save
- 期待: 正規化ルールに従い Trim 後は同名と見なされるため正常保存（事実上の変更なし）

6) 部分失敗シミュレーション（ディスク書き込み失敗）
- 操作: 保存先のプロファイルファイルが読み取り専用等で書き込みに失敗するようにして Save（手動でファイル属性を変更）
- 期待: 保存に失敗したことがユーザーに通知され、UI 上での整合が保たれる（理想: メモリ上の状態がロールバックされる）。現状では最小限の保護のみあるためログを確認。

## ログ確認ポイント
- 保存時に発行されるログで以下が確認できると良い
  - 保存要求の old/new 名
  - プロファイル配列内の置換結果（old->new）
  - ActionCol 内のインデックスと内容（保存前後）

## 実行手順（簡易）
1. VS Code でソリューションをビルド: `dotnet build DS4WindowsWPF.sln -c Debug`
2. Visual Studio または `dotnet run` 相当でアプリを起動
3. `Profile Editor` を開き、対象アクションを編集して上記テストを実行
4. 実行ごとにログ（`%APPDATA%` のログやアプリ内ログ）を確認

## 期待結果の判断基準
- 「重複検出」は UI がブロックして保存を拒否すること
- 「プロファイル参照置換」は編集中プロファイルのみを自動更新すること
- 「UIの重複」は再現しないこと

----

必要ならばこのドキュメントを拡張して、個別手順のスクリーンショット、ログの抜粋、あるいは自動化テスト（UI 自動化）への移行手順を追加します。